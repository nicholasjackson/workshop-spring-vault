# Database Encryption

In the last section you learned how to confgiure database credentials using Vault
for your Spring applications. In this section you will learn how to us Vault's 
Transit Secrets Engine to encrypt and decrypt data in your database.

## Enabling the Transit Secrets Engine

All engines and authentication methods must be enabled at a particular path before they can be used. This is usually a one-time operation. Let's enable the transit secrets engine

```shell
vault secrets enable transit
```

## Creating encryption keys

To encrypt and decrypt data using the Transit Secrets Engine, you need to create 
an encryption key. You can create multiple keys for different purposes. 
There are also many different types of keys that you can create, such as
AES, RSA, and ECDSA.

Sinve the keys are managed by Vault it is generally a good idea to create a new key
for each application that needs to encrypt data. This way you can easily rotate the key
without affecting other applications. The keys are securely stored inside of Vault
and unless you explicitly state that you would like to export the key, it is not possible
to retrieve the key.

Run the following command to create a new RSA 4096 encryption key:

```shell
vault write -f transit/keys/payments type=rsa-4096
```

## Encrypting data

Let's see how we can use this key to encrypt data. Run the following command to encrypt the
credit card number. Note the `plaintext` parameter requires base64 encoded text.

```shell
vault write transit/encrypt/payments plaintext=$(base64 <<< "1234-5678-9012-3456")
```

The output will be a `ciphertext` value that you can store in your database.

NOTE: The `ciphertext` value is probably going to be larger than the original credit card number, if
you have a size limit on the column you may need to increase it.

```
Key            Value
---            -----
ciphertext     vault:v1:FjxqFe1w3SSzTTjl+o2rhwL+Ez8sJjmT7jRSbbLJhzErw2ZY9da0EkD0xbBMyY1Gi+Z7VLNkq2PzCqvojfqs5ypQv2qCCg/K8TFRGyOMIIVIBSRGyuFl/7YRh7w7YmLFTnMAczhNkIs10drAiDTxOif1COMyKFNu9WmCSGezKrrq7XX2qRB+fIyMecerPMfBakXD53nU4oQYNYRQ8IfizQwvCRelhlO6LiwfjHM3CjIJVgJaBK8xp/Og1yraMNRgyN4TkBhcid8rTdK+EYEY6Q7nx/G6zLbNu6UOkgD7GsPnSH/zdD8ksNkuw7QlTEqSSaLNbDLihM/mOxcp7KAGVH/FEr6p4Wy6OvlLc0R/t4ksv4PElb9L0YpVgZdPaCMIaqGFj0TfW8IS5yCIhwqDuUPBjNY+/UuDJEDzjWa1UkFGWV/GesMECqlPRwkHlWtzG0R0s41hksveUrzfzrupQUba7yLsHegiL1hUM33YPAzozBstJsvSg9T3Rz9+UsOrz2eCzRlq/laS030bhOO7JJs8NpPIwf0O8PeKBBQIjCCwE0ZB+Dr7Nrk9s2ZjKLApbjSnnwIyALTkddrEq8u5w/F2To4mKfJSjMLMYeMaWiqj1wKyErqYVqnVg4esAARFKF/FVHpNbgCdkj4Q9EsBGDd7LqKgGwtjMBzOQk/wcxg=
key_version    1
```

## Decrypting data

To decrypt the data, you can use the `decrypt` endpoint. Run the following command to decrypt the data:

```shell
vault write transit/encrypt/payments ciphertext=<ciphertext>
```

The output will be the decrypted value.

```shell
Key          Value
---          -----
plaintext    MTIzNC01Njc4LTkwMTItMzQ1Ngo=
```

You can then decode the base64 encoded value to get the original value.

```shell
echo <plaintext> | base64 --decode
```

You should see the original credit card number:

```shell
1234-5678-9012-3456
```

In this section you learned how to encrypt and decrypt data using Vault's Transit Secrets Engine. In the next section you will learn how to integrate this into your Spring Boot application.
```
